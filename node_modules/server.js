
const express = require('express');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');

const app = express();
const port = 3000;

app.use(express.json());

const SECRET_KEY = "MY_SECRET_KEY";

// Dummy user database
let users = [
  { id: 1, username: "admin", password: bcrypt.hashSync("admin123", 10), nama: "Administrator" }
];

// ================= LOGIN =================
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  const user = users.find(u => u.username === username);

  if (!user) return res.status(401).json({ message: "Username salah" });

  const validPassword = bcrypt.compareSync(password, user.password);
  if (!validPassword) return res.status(401).json({ message: "Password salah" });

  const token = jwt.sign({ id: user.id }, SECRET_KEY, { expiresIn: "1h" });

  res.json({ message: "Login berhasil", token });
});

// ============ Middleware Authentication ============
function auth(req, res, next) {
  const header = req.headers['authorization'];
  if (!header) return res.status(401).json({ message: "Token diperlukan" });

  const token = header.split(" ")[1];
  jwt.verify(token, SECRET_KEY, (err, decoded) => {
    if (err) return res.status(401).json({ message: "Token tidak valid" });
    req.user = decoded;
    next();
  });
}

// ================= GET semua user =================
app.get('/users', auth, (req, res) => {
  const safeUsers = users.map(u => ({ id: u.id, username: u.username, nama: u.nama }));
  res.json(safeUsers);
});

// ================= GET user by ID =================
app.get('/users/:id', auth, (req, res) => {
  const id = parseInt(req.params.id);
  const user = users.find(u => u.id === id);

  if (!user) return res.status(404).json({ message: "User tidak ditemukan" });

  res.json({ id: user.id, username: user.username, nama: user.nama });
});

// ================= CREATE user =================
app.post('/users', auth, (req, res) => {
  const { username, password, nama } = req.body;

  const newUser = {
    id: users.length + 1,
    username,
    password: bcrypt.hashSync(password, 10),
    nama
  };

  users.push(newUser);

  res.status(201).json({ message: "User berhasil dibuat", data: newUser });
});

// ================= UPDATE user =================
app.put('/users/:id', auth, (req, res) => {
  const id = parseInt(req.params.id);
  const user = users.find(u => u.id === id);

  if (!user) return res.status(404).json({ message: "User tidak ditemukan" });

  const { username, password, nama } = req.body;

  user.username = username ?? user.username;
  user.nama = nama ?? user.nama;
  if (password) user.password = bcrypt.hashSync(password, 10);

  res.json({ message: "User berhasil diupdate", data: user });
});

app.listen(port, () => {
  console.log(`Server berjalan di http://localhost:${por3000t}`);
});
